---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: test-policy
  namespace: openshift-gitops
spec:
  refreshInterval: "60s"
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: test-policy
    manifest:
      apiVersion: policy.open-cluster-management.io/v1
      kind: Policy
    template:
      engineVersion: v2
      mergePolicy: Merge
      metadata:
        annotations:
          policy.open-cluster-management.io/categories: AC Access Control
          policy.open-cluster-management.io/controls: AC-3 Access Enforcement
          policy.open-cluster-management.io/standards: NIST SP 800-53
        labels:
          requires-rolling-restart: none
        name: test-policy
      templateFrom:
      - literal: |
          disabled: false
          policy-templates:
          - objectDefinition:
              apiVersion: policy.open-cluster-management.io/v1
              kind: ConfigurationPolicy
              metadata:
                name: test-policy
              spec:
                object-templates:
                  - complianceType: musthave
                    objectDefinition:
                      apiVersion: v1
                      kind: Namespace
                      metadata:
                        labels:
                          openshift.io/cluster-monitoring: "true"
                        name: test
                  - complianceType: musthave
                    objectDefinition:
                      kind: Secret
                      apiVersion: v1
                      stringData:
                        ANSIBLE_VAULT_SECRET: "{{.ansibleVaultSecret}}"
                      metadata:
                        name: vault-init
                        namespace: test
                      type: Opaque
                remediationAction: inform
                severity: low
          remediationAction: enforce
        target: spec
  data:
  - secretKey: ansibleVaultSecret
    remoteRef:
      key: kv/data/ocp/sno/openshift-gitops/policies
      property: ANSIBLE_VAULT_SECRET
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: binding-policy-test-policy
  namespace: openshift-gitops
placementRef:
  kind: Placement
  apiGroup: cluster.open-cluster-management.io
  name: placement-hub-openshift
subjects:
  - apiGroup: policy.open-cluster-management.io
    kind: Policy
    name: test-policy
